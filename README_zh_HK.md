# 學校調查報告生成器

一個基於學生回應自動生成全面學校調查報告的系統。此工具處理 Excel 調查數據，並生成包含統計分析、可視化圖表和 AI 生成見解的格式化 Word 文檔。

[English Version](README.md)

## 安裝

您可以直接在線使用 PPT 報告生成器：[https://pptgenerator-uqzlepmjiojt6h6mowtmk7.streamlit.app/](https://pptgenerator-uqzlepmjiojt6h6mowtmk7.streamlit.app/)，並跳過以下步驟。

如果您想在本地運行，請按照以下步驟操作：

1. 確保您使用的是 Python 3.10 或更高版本。

1. 克隆存儲庫：
   ```bash
   git clone https://github.com/ansonk4/report_gen.git
   cd report
   ```

2. 安裝 Python 依賴項：
   ```bash
   pip install -r requirements.txt
   ```

4. 運行 Streamlit 網頁界面：
   ```bash
   streamlit run src/streamlit/main.py
   ```

## 使用方法

學校調查報告生成器可以通過在線託管版本或在您的機器上本地使用。該系統提供了一個用戶友好的網頁界面，包含兩個主要部分：

### 主界面（報告生成器）

1. **配置設置（側邊欄）**
    **基本信息**：輸入學校名稱，選擇是為所有學校還是特定學校生成報告，並設置調查年份。
    
    **LLM 設置**：選擇用於生成見解的 AI 提供商：
    - **禁用（默認）**：報告中將不包含 AI 生成的見解。
    - **Gemini**：需要 VPN 連接。如果您將 `GEMINI_API_KEY` 留空並將 `Model` 設為默認值，系統將使用默認 API 密鑰和模型。如果選擇 Gemini 後報告生成失敗，則可能是默認 API 密鑰或模型已過期。請參閱 [LLM 設置](#LLM-設置) 部分了解設置說明。
    - **OpenRouter**：如果您將 `OPENROUTER_API_KEY` 留空並將 `Model` 設為默認值，系統將使用默認 API 密鑰和模型。如果選擇 OpenRouter 後報告生成失敗，則可能是默認 API 密鑰或模型已過期。請參閱 [LLM 設置](#LLM-設置) 部分了解設置說明。

    **文件和輸出路徑**：可選地設置模板文件、輸出報告和圖像目錄的自定義位置。

2. **文件上傳**
   - **模板文件（可選）**：如果您想使用與 [默認模板](doc/template.docx) 不同的格式，可以上傳自定義 Word 模板（.docx）。（不推薦）
   - **數據文件（必需）**：以 Excel 格式（.xlsx）上傳您的調查數據。
   - **樣本數據**：下載樣本 Excel 文件以了解所需的格式和列。

3. **數據驗證**
   - 上傳數據文件後，系統會自動根據所需列和值格式進行驗證。
   - 任何驗證錯誤都將顯示具體的行和列信息。
   - 無效的數據值在處理過程中將被替換為 NA。

4. **報告生成**
   - 驗證成功後，點擊「生成報告」按鈕。
   - 系統將創建可視化圖表並生成 Word 文檔報告。
   - 使用下載按鈕下載您完成的報告。
   - 在界面中直接查看生成的可視化圖表。

### 問卷編輯器

問卷編輯器允許您自定義調查數據中使用的專業和職業映射。

1. **專業標籤頁**
   - 添加帶有代碼、名稱、類別和中文名稱的新專業。
   - 使用數據編輯器表格編輯現有專業。
   - 點擊「更新專業」按鈕更新更改。

2. **職業標籤頁**
   - 添加帶有代碼、名稱、類別和中文名稱的新職業。
   - 使用數據編輯器表格編輯現有職業。
   - 點擊「更新職業」按鈕更新更改。

3. **專業影響標籤頁**
   - 修改用於生成專業影響因素圖的 Excel 列。
   - 列名必須以 '_A' 結尾。
   - 更新每個單元格後請按 Enter。

4. **職業影響標籤頁**
   - 修改用於生成職業影響因素圖的 Excel 列。
   - 列名必須以 '_B' 結尾。
   - 更新每個單元格後請按 Enter。

### LLM 設置

#### Gemini

##### API 密鑰設置
1. 訪問 [Google Cloud Resource Manager](https://console.cloud.google.com/cloud-resource-manager) 並創建一個新的 Google Cloud 項目。
2. 啟用 VPN 以訪問香港以外的服務。
3. 前往 [Google AI Studio API Keys](https://aistudio.google.com/apikey)。
4. 點擊右上角的 `+ Create API Key`。
5. 選擇您的項目並確認創建 API 密鑰。
6. 複製生成的 API 密鑰並粘貼到 Streamlit 頁面的 LLM 設置部分。

##### 模型設置
1. 訪問 [Google AI Studio](https://ai.google.dev/gemini-api/docs/models)
2. 複製您選擇的模型名稱（例如 `gemini-2.5-flash`）並粘貼到 Streamlit 頁面的 LLM 設置部分。

#### OpenRouter

##### API 密鑰設置
1. 在 [OpenRouter](https://openrouter.ai/) 登錄。
2. 導航到 [API Keys Settings](https://openrouter.ai/settings/keys)。
3. 點擊 `Create API Key`。
4. 輸入名稱並確認創建。
5. 複製 API 密鑰並粘貼到 Streamlit 頁面的 LLM 設置部分。

##### 模型設置
1. 訪問 [OpenRouter](https://openrouter.ai/models) 並查找免費(`free`)模型。
2. 複製其名稱（例如 `openai/gpt-oss-20b:free`）並粘貼到 Streamlit 頁面的 LLM 設置部分。

#### 可選：
要更改默認本地 API 密鑰，請在您的項目目錄中創建一個 `.env` 文件，內容如下：

```
OPENROUTER_KEY=[您的 OpenRouter API 密鑰]
GEMINI_API_KEY=[您的 Gemini API 密鑰]
```

### 獲得最佳結果的提示

1. 始終從下載和檢查樣本數據文件開始，以了解所需的格式。
2. 確保數據文件中包含所有必需的列。
3. 遵循每列的值驗證規則，以避免數據處理錯誤。
4. 如有需要，使用問卷編輯器自定義專業和職業映射。

### 常見問題

- **專業/職業的中文名稱無效**：您的 Excel 文件中的專業或職業可能由於中文字符的細微差異而被標記為無效（例如 `市埸營銷/公關` 與 `市場營銷/公關`）。系統將這些視為不同的值。

    **解決方案**：為確保一致性，請直接從 README 或問卷編輯器複製專業或職業名稱。您也可以使用問卷編輯器更新和更正映射。

- **LLM 見解錯誤或輸出缺失（Gemini/OpenRouter）**

    常見原因和解決方案：

    1. **API 密鑰無效**
    *解決方案*：在 LLM 設置部分驗證您的 API 密鑰是否正確。如果使用 `.env` 文件，請確保密鑰與所選提供商匹配。

    2. **Gemini 需要 VPN**
    *解決方案*：Gemini 需要連接香港以外的 VPN。生成報告前請激活您的 VPN。

    3. **速率限制（請求過多）**
    *解決方案*：等待幾分鐘或稍後再試。如果問題仍然存在，請使用不同的 API 密鑰或提供商。

    4. **模型不可用**
    *解決方案*：在側邊欄的「模型」字段中輸入受支持的模型名稱。請參閱 Gemini/OpenRouter 文檔了解可用模型並更新您的選擇。

## 輸入數據格式

系統需要一個具有特定列和值格式的 Excel 文件。您可以參考 [sample.xlsx](sample_data/sample.xlsx) 文件了解所需的結構和格式。我們建議按照此樣本準備您自己的調查數據。

以下列 **必須** 出現在您的 Excel 文件中，並且只能包含指定列表中的值：

#### 基本信息
列：`問卷編號`
- 整數

列：`學校編號`
- 整數

列：`Banding`
- `Band 1`
- `Band 2`
- `Band 3`

#### 學生人口統計
列：`性別`
- `男`
- `女`

列：`高中選修學科`
- `理科`
- `商科`
- `理商科`
- `文科`
- `文理科`
- `文商科`
- `文理商科`

#### 學業成績
列：`中文成績`, `英文成績`, `數學成績`
- `< 25 分`
- `25-49 分`
- `50-75 分`
- `> 75 分`

列：`父母教育程度`
- `小學`
- `初中`
- `高中`
- `預科`
- `大專 (非學士學位)`
- `大學`
- `學士後課程或以上`

#### 考試後計劃
列：`試後計劃`
- `進修`
- `工作`
- `進修及工作`
- `其他`

列：`香港`, `內地`, `亞洲`, `歐美澳`
- `1` (第一選擇)
- `2` (第二選擇)
- `3` (第三選擇)
- `4` (第四選擇)

列：`工作地方`
- `香港`
- `內地`
- `國外 - 亞洲`
- `國外 - 歐美澳`

列：`大學`, `副學士`, `文憑`, `高級文憑`, `工作`, `工作假期`, `其他`
- `0` (未選擇)
- `1` (已選擇)

#### 大學選擇因素
列：`學科知識`, `院校因素`, `大學學費`, `助學金`, `主要行業`, `朋輩老師`, `家庭因素`, `預期收入`, `DSE成績`, `高中選修科目`
- `十分重要`
- `重要`
- `不太重要`
- `不重要`

#### STEM 參與
列：`參加STEM`
- `有`
- `沒有`

#### 技能發展
列：`領導能力`, `團隊合作`, `創新思維`, `科學知識`, `解難能力`
- `顯著提升`
- `部分提升`
- `較少提升`
- `沒有提升`
- `0` (不適用)

#### 職業決定因素
列：`個人能力_B`, `個人興趣性格_B`, `成就感_B`, `家庭因素_B`, `人際關係_B`, `工作性質_B`, `工作模式_B`, `工作量_B`, `工作環境_B`, `薪水及褔利_B`, `晉升機會_B`, `發展前景_B`, `社會貢獻_B`, `社會地位_B`
- `十分重要`
- `重要`
- `不太重要`
- `不重要`

#### 粵港澳大灣區認知
列：`大灣區了解`
- `完全不了解`
- `不太了解`
- `了解`
- `非常了解`

#### 壓力評估
列：`壓力程度`
- `完全沒有`
- `較少`
- `少`
- `大`
- `較大`
- `非常大`

列：`壓力來源`
- `個人因素`
- `外在因素`

列：`承受壓力`
- `完全不能`
- `大部分不能`
- `大部分能夠`
- `完全能夠`

#### 壓力應對策略

列：`家人期望`, `朋輩比較`, `密集的時間表`, `考試成績`, `人際關係`, `個人前途`, `個人期望`, `長期獨處`, `疫情`, `上課不穩定`, `調動考試`
- `0` (未選擇)
- `1` (已選擇)

列：`做運動`, `家人溝通`, `朋友溝通`, `尋求社工`, `重整時間表`, `打遊戲機`, `睡覺`, `聼音樂`, `沒有概念`
- `0` (未選擇)
- `1` (已選擇)

#### 專業偏好
列：`希望修讀`, `希望修讀_A`, `希望修讀_B`, `不希望修讀`, `不希望修讀_A`, `不希望修讀_B`
- [major_job_zh.yaml](src/major_job_zh.yaml) 中的默認專業或您在問卷編輯器專業標籤頁中創建的自定義列表

#### 職業偏好
列：`希望從事`, `希望從事_A`, `希望從事_B`, `不希望從事`, `不希望從事_A`, `不希望從事_B`
- [major_job_zh.yaml](src/major_job_zh.yaml) 中的默認職業或您在問卷編輯器職業標籤頁中創建的自定義列表

### 特殊值

所有列都接受 `999` 作為特殊值，表示「不適用」或「跳過」。此值在數據處理過程中將轉換為 NaN。

## 未指定的列

- 未在 [輸入數據格式](#輸入數據格式) 中列出的列不會被系統使用或驗證；您可以根據需要刪除或修改它們。

## 項目結構

```
report/
├── src/                    # 源代碼
│   ├── auto_gen.py         # 自動報告生成腳本
│   ├── document_generator.py # 主報告生成引擎
│   ├── data_converter.py   # 數據轉換和驗證工具
│   ├── read_csv.py         # 數據讀取和處理
│   ├── mapping.py          # 數據映射函數
│   ├── plotter.py          # 數據可視化
│   ├── prompt_template.py  # AI 提示模板
│   ├── conclusion_gen.py   # LLM 集成
│   ├── questionnaire.yaml  # 問卷映射
│   └── major_job_zh.yaml   # 中文專業/職業映射
├── sample_data/            # 樣本調查數據
│   ├── sample_data.xlsx    # 原始調查數據
│   └── converted_data.xlsx # 處理後的數據
├── doc/                    # 文檔模板和示例
│   ├── template.docx       # 報告模板
│   └── filled_report.docx  # 生成的報告示例
├── output/                 # 生成的報告
├── img/                    # 生成的圖表和圖像
├── requirements.txt        # Python 依賴項
└── packages.txt            # 系統依賴項
```